<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Konsultasi AI Lius Retang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Menggunakan font Poppins yang populer di kalangan Gen Z */
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap");

      /* Variabel CSS dari tema Panda Login */
      :root {
        --bg: #0f1226;
        --card: #161a36;
        --accent: #7c5cff;
        --accent-2: #00e7d0;
        --text: #e9ecff;
        --muted: #a6b0d9;
        --danger: #ff4d6d;
      }

      body {
        font-family: "Poppins", sans-serif;
        transition: background-color 0.3s ease; /* Transisi untuk perubahan tema */
        min-height: 100vh; /* Memastikan body mengisi seluruh tinggi viewport */
        display: flex;
        flex-direction: column; /* Body sebagai flex container utama */
        align-items: center; /* Pusat horizontal */
        justify-content: flex-start; /* Konten dimulai dari atas */
        padding: 1rem; /* Padding global untuk tampilan yang lebih baik di mobile */
        box-sizing: border-box;
        overflow-y: auto; /* Memungkinkan body untuk di-scroll jika konten melebihi viewport */

        /* Latar belakang dari tema Panda Login */
        background: radial-gradient(
            1200px 800px at 85% -10%,
            rgba(124, 92, 255, 0.25),
            transparent
          ),
          radial-gradient(
            800px 600px at -10% 90%,
            rgba(0, 231, 208, 0.25),
            transparent
          ),
          var(--bg);
        color: var(--text); /* Warna teks default */
      }

      .container-bg {
        /* Styling dari tema Panda Login */
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.06),
          rgba(255, 255, 255, 0.02)
        );
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45),
          inset 0 0 0 1px rgba(255, 255, 255, 0.06);

        border-radius: 1.5rem; /* Sudut lebih membulat */
        display: flex; /* Kontainer utama juga flex */
        flex-direction: column; /* Konten di dalamnya bertumpuk */
        width: 100%;
        max-width: 90%; /* Lebar maksimum untuk mobile */
        flex-shrink: 0; /* Pastikan container tidak menyusut paksa */
        max-height: calc(
          100vh - 2rem
        ); /* Mengambil sebagian besar tinggi viewport minus padding body */
        box-sizing: border-box;
        margin-top: auto; /* Pusatkan secara vertikal jika ada ruang */
        margin-bottom: auto; /* Pusatkan secara vertikal jika ada ruang */

        /* Responsivitas lebar */
        @media (min-width: 768px) {
          /* md breakpoint */
          max-width: 700px; /* Batasi lebar agar tidak terlalu besar di tablet/desktop */
        }
        @media (min-width: 1024px) {
          /* lg breakpoint */
          max-width: 850px;
        }
      }

      /* Header dan welcome message */
      .header-section {
        padding: 1.5rem 2rem; /* Padding konsisten */
        text-align: center;
        flex-shrink: 0; /* Agar tidak menyusut saat ruang terbatas */
      }
      .header-section h1 {
        color: var(--text); /* Warna teks judul */
      }
      .header-section p {
        color: var(--muted); /* Warna teks muted */
      }

      /* Bagian utama chat dan input */
      .main-chat-area {
        flex-grow: 1; /* Memungkinkan bagian ini mengambil sisa ruang vertikal */
        display: flex;
        flex-direction: column;
        padding: 0 2rem; /* Padding horizontal konsisten */
        overflow: hidden; /* Mengelola overflow untuk child */
        min-height: 0; /* Penting untuk flex items di flex-direction column yang memiliki overflow */
      }

      /* Area pesan chat (SCROLLABLE) */
      #chatMessages {
        flex-grow: 1; /* Memungkinkan area pesan mengambil sisa ruang di dalam main-chat-area */
        overflow-y: auto; /* Aktifkan scrolling vertikal */
        padding: 1rem; /* Padding di dalam area scroll */
        border-radius: 0.75rem; /* Sudut lebih lembut */
        background: rgba(
          255,
          255,
          255,
          0.04
        ); /* Latar belakang chat messages yang lebih gelap */
        border: 1px solid rgba(255, 255, 255, 0.06); /* Border yang lebih soft */
        display: flex;
        flex-direction: column;
        gap: 0.75rem; /* Spasi antar bubble chat */
        margin-bottom: 1rem; /* Spasi di bawah area chat, sebelum input */
        box-sizing: border-box;
      }
      #chatMessages::-webkit-scrollbar {
        width: 8px;
      }
      #chatMessages::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }
      #chatMessages::-webkit-scrollbar-track {
        background-color: transparent;
      }
      #initialChatMessage {
        color: var(--muted); /* Warna teks placeholder */
      }

      /* Input dan tombol kirim */
      .chat-input-section {
        padding-bottom: 1.5rem; /* Padding bawah konsisten */
        flex-shrink: 0; /* Agar tidak menyusut saat ruang terbatas */
      }
      .chat-input-section input {
        /* Styling input dari tema Panda Login */
        width: 100%;
        padding: 14px 14px 14px 14px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(7, 10, 26, 0.6);
        color: var(--text);
        outline: none;
        transition: 0.25s border-color, 0.25s box-shadow, 0.25s background;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
        min-height: 44px; /* Tinggi minimum untuk kemudahan sentuh */
      }
      .chat-input-section input::placeholder {
        color: var(--muted);
      }
      .chat-input-section input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 4px rgba(124, 92, 255, 0.15);
        background: rgba(7, 10, 26, 0.8);
      }

      .chat-input-section button {
        /* Styling tombol dari tema Panda Login */
        padding: 12px 16px;
        border-radius: 14px;
        border: none;
        cursor: pointer;
        font-weight: 700;
        letter-spacing: 0.3px;
        background: linear-gradient(
          90deg,
          var(--accent),
          var(--accent-2)
        ); /* Default primary btn */
        color: #0f1020; /* Warna teks pada tombol utama */
        min-height: 44px; /* Tinggi minimum untuk kemudahan sentuh */
      }
      .chat-input-section button:hover {
        opacity: 0.9; /* Efek hover sederhana */
      }

      /* Styling pesan chat yang normal */
      .message-container {
        display: flex;
        width: 100%;
      }
      .message-container.sent {
        justify-content: flex-end; /* Pesan dari pengguna di kanan */
      }
      .message-container.received {
        justify-content: flex-start; /* Pesan dari konsultan/lainnya di kiri */
      }

      .message-bubble {
        /* Disesuaikan untuk tampilan mobile */
        max-width: 90%; /* Perbesar sedikit di mobile agar teks tidak terlalu terpotong */
        padding: 0.75rem 1rem; /* Padding di dalam bubble */
        border-radius: 1.25rem; /* Sudut bubble lebih membulat */
        word-wrap: break-word; /* Pesan panjang akan menyesuaikan */
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        line-height: 1.4; /* Kerapatan teks */
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: flex-start; /* Default align text to start */
      }

      /* Panah kecil pada bubble chat */
      .message-bubble::before {
        content: "";
        position: absolute;
        width: 0;
        height: 0;
        border-style: solid;
        bottom: 0px; /* Panah di bagian bawah bubble */
      }

      .message-bubble.sent {
        background-color: #5b21b6; /* Ungu tua untuk sent messages (cocok di dark mode) */
        color: #d8b4fe; /* Teks ungu muda */
        border-bottom-right-radius: 0.25rem; /* Sudut kanan bawah lebih tajam */
        align-self: flex-end;
        align-items: flex-end;
      }
      .message-bubble.sent::before {
        border-width: 0 10px 10px 0;
        border-color: transparent #5b21b6 transparent transparent;
        right: -8px; /* Posisi panah */
      }

      .message-bubble.received {
        background-color: #1f2937; /* Abu-abu gelap untuk received messages (cocok di dark mode) */
        color: var(--text); /* Teks putih/terang */
        border-bottom-left-radius: 0.25rem; /* Sudut kiri bawah lebih tajam */
        align-self: flex-start;
        align-items: flex-start;
      }
      .message-bubble.received::before {
        border-width: 10px 10px 0 0;
        border-color: transparent transparent transparent #1f2937;
        left: -8px; /* Posisi panah */
      }

      .message-sender {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--muted); /* Warna nama pengirim */
      }

      .message-time {
        font-size: 0.7rem; /* Ukuran waktu lebih kecil */
        color: var(--muted); /* Abu-abu */
        margin-top: 0.5rem; /* Spasi dari teks pesan */
      }

      /* Styling untuk loading indicator */
      .loading-dots span {
        animation: bounce 1.4s infinite ease-in-out both;
        background-color: var(--muted); /* Warna dots mengikuti tema */
      }
      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      /* Animasi Selamat Datang */
      .fade-in-up {
        animation: fadeInUp 1s ease-out forwards;
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Tombol tema */
      .theme-toggle-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s ease, transform 0.2s ease;
        z-index: 1000;
      }
      .theme-toggle-btn:hover {
        transform: scale(1.1);
      }

      /* Tema Default (Panda/Gelap) - Ini akan menjadi dasar theme-green */
      body.theme-green {
        background: radial-gradient(
            1200px 800px at 85% -10%,
            rgba(124, 92, 255, 0.25),
            transparent
          ),
          radial-gradient(
            800px 600px at -10% 90%,
            rgba(0, 231, 208, 0.25),
            transparent
          ),
          var(--bg);
        color: var(--text);
      }
      body.theme-green .container-bg {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.06),
          rgba(255, 255, 255, 0.02)
        );
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45),
          inset 0 0 0 1px rgba(255, 255, 255, 0.06);
      }
      body.theme-green .theme-toggle-btn {
        background-color: var(--accent); /* Warna accent dari Panda */
      }
      body.theme-green .theme-toggle-btn svg {
        color: #ffffff;
      }
      body.theme-green .message-bubble.sent {
        background-color: #5b21b6; /* Ungu tua */
        color: #d8b4fe;
      }
      body.theme-green .message-bubble.sent::before {
        border-color: transparent #5b21b6 transparent transparent;
      }
      body.theme-green .message-bubble.received {
        background-color: #1f2937; /* Abu-abu gelap */
        color: var(--text);
      }
      body.theme-green .message-bubble.received::before {
        border-color: transparent transparent transparent #1f2937;
      }
      body.theme-green .chat-input-section input {
        background: rgba(7, 10, 26, 0.6);
        border-color: rgba(255, 255, 255, 0.1);
        color: var(--text);
      }
      body.theme-green .chat-input-section input::placeholder {
        color: var(--muted);
      }
      body.theme-green .chat-input-section input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 4px rgba(124, 92, 255, 0.15);
        background: rgba(7, 10, 26, 0.8);
      }
      body.theme-green .chat-input-section button {
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        color: #0f1020;
      }
      body.theme-green .chat-input-section button:hover {
        opacity: 0.9;
      }
      body.theme-green #chatMessages {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      body.theme-green #initialChatMessage,
      body.theme-green .message-sender,
      body.theme-green .message-time {
        color: var(--muted);
      }
      body.theme-green .loading-dots span {
        background-color: var(--muted);
      }

      /* Tema Pink */
      body.theme-pink {
        background-color: #ffe6f2; /* Latar pink muda */
        color: #4a0429; /* Teks default pink lebih gelap */
      }
      body.theme-pink .container-bg {
        background-color: #fff0f5; /* Container pink lebih gelap */
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1),
          inset 0 0 0 1px rgba(255, 255, 255, 0.06); /* Shadow tetap ada */
        border: 1px solid rgba(255, 255, 255, 0.3); /* Border lebih terang */
        backdrop-filter: none; /* Matikan blur di mode terang */
      }
      body.theme-pink .theme-toggle-btn {
        background-color: #ec4899; /* Pink */
      }
      body.theme-pink .theme-toggle-btn svg {
        color: #ffffff;
      }
      body.theme-pink .message-bubble.sent {
        background-color: #fbcfe8; /* Pink lebih terang */
        color: #db2777; /* Teks pink gelap */
      }
      body.theme-pink .message-bubble.sent::before {
        border-color: transparent #fbcfe8 transparent transparent;
      }
      body.theme-pink .message-bubble.received {
        background-color: #e0e7ff; /* Biru sangat muda (cocok dengan pink) */
        color: #4f46e5; /* Biru keunguan */
      }
      body.theme-pink .message-bubble.received::before {
        border-color: transparent transparent transparent #e0e7ff;
      }
      body.theme-pink .chat-input-section input {
        background: #ffffff;
        border-color: #e2e8f0;
        color: #4a0429;
      }
      body.theme-pink .chat-input-section input::placeholder {
        color: #a0aec0;
      }
      body.theme-pink .chat-input-section input:focus {
        border-color: #ec4899; /* Pink */
        box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.15); /* Pink shadow */
        background: #ffffff;
      }
      body.theme-pink .chat-input-section button {
        background-color: #db2777; /* Tombol jadi pink gelap */
        color: #ffffff;
      }
      body.theme-pink .chat-input-section button:hover {
        background-color: #be185d; /* Hover tombol pink lebih gelap */
      }
      body.theme-pink #chatMessages {
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
      }
      body.theme-pink #initialChatMessage,
      body.theme-pink .message-sender,
      body.theme-pink .message-time {
        color: #6b7280;
      }
      body.theme-pink .header-section h1 {
        color: #2d3748; /* Warna teks judul */
      }
      body.theme-pink .header-section p {
        color: #718096; /* Warna teks muted */
      }
      body.theme-pink .loading-dots span {
        background-color: #6b7280; /* Warna dots mengikuti tema */
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col items-center">
    <div class="container-bg p-0 rounded-3xl">
      <div class="header-section">
        <h1 class="text-3xl sm:text-4xl font-bold mb-2 fade-in-up">
          AI Lius Retang Hub!
        </h1>
        <p id="welcomeMessage" class="text-base">Memuat...</p>
      </div>

      <div id="content" class="hidden flex flex-col flex-grow main-chat-area">
        <p class="text-center mb-4" style="color: var(--muted)">
          Mulai konsultasi Anda sekarang:
        </p>

        <div id="chatMessages" class="rounded-lg text-left">
          <p id="initialChatMessage" class="text-center text-sm">
            Mulai konsultasi Anda!
          </p>
        </div>

        <div
          class="chat-input-section flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3"
        >
          <input type="text" id="chatInput" placeholder="Ketik pesan Anda..." />
          <button id="sendMessageBtn">Kirim</button>
        </div>
        <div
          id="loadingIndicator"
          class="hidden mt-4 text-sm flex items-center justify-center pb-4"
        >
          <span>Lius sedang mengetik</span>
          <span class="loading-dots ml-2">
            <span class="inline-block w-2 h-2 rounded-full mx-0.5"></span>
            <span class="inline-block w-2 h-2 rounded-full mx-0.5"></span>
            <span class="inline-block w-2 h-2 rounded-full mx-0.5"></span>
          </span>
        </div>
      </div>

      <button
        id="logoutBtn"
        class="w-full mt-4 mb-4 mx-auto block max-w-[calc(100%-4rem)] bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out"
      >
        Logout
      </button>
    </div>

    <div id="themeToggleBtn" class="theme-toggle-btn">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="lucide lucide-palette"
      >
        <circle cx="12" cy="12" r="10" />
        <path d="M14.5 9.5a2.5 2.5 0 0 1 5 0v5a2.5 2.5 0 0 1-5 0Z" />
        <path d="M6 9.5h2.5a2.5 2.5 0 0 1 0 5H6a2.5 2.5 0 0 1 0-5Z" />
        <path d="M12 7.5V6a2.5 2.5 0 0 0-5 0v1.5a2.5 2.5 0 0 0 5 0Z" />
        <path d="M12 16.5V18a2.5 2.5 0 0 1-5 0v-1.5a2.5 2.5 0 0 1 5 0Z" />
      </svg>
    </div>

    <audio
      id="backgroundMusic"
      loop
      preload="auto"
      src="L.mp3"
      style="display: none"
    ></audio>

    <div
      id="modal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl w-80 text-center">
        <h3 id="modalTitle" class="text-xl font-bold mb-4 text-gray-800">
          Pesan
        </h3>
        <p id="modalMessage" class="text-gray-700 mb-6"></p>
        <button
          id="modalCloseBtn"
          class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg"
        >
          OK
        </button>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        orderBy,
        onSnapshot,
        serverTimestamp,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

      // Konfigurasi Firebase Anda (SAMA DENGAN index.html)
      const firebaseConfig = {
        apiKey: "AIzaSyBMs2O5rThet-0CnN1Pec0fNpD_Y_z9ox4", // GANTI DENGAN API KEY ANDA
        authDomain: "konsultasi-saya.firebaseapp.com",
        projectId: "konsultasi-saya",
        storageBucket: "konsultasi-saya.firebasestorage.app",
        messagingSenderId: "1090569635887",
        appId: "1:1090569635887:web:a5441ac4e7d0f9014adeda",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Ambil elemen HTML
      const welcomeMessage = document.getElementById("welcomeMessage");
      const contentDiv = document.getElementById("content");
      const logoutBtn = document.getElementById("logoutBtn");
      const chatInput = document.getElementById("chatInput");
      const sendMessageBtn = document.getElementById("sendMessageBtn");
      const chatMessagesDiv = document.getElementById("chatMessages");
      const loadingIndicator = document.getElementById("loadingIndicator");
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const initialChatMessage = document.getElementById("initialChatMessage");
      const backgroundMusic = document.getElementById("backgroundMusic"); // Ambil elemen audio

      const modal = document.getElementById("modal");
      const modalTitle = document.getElementById("modalTitle");
      const modalMessage = document.getElementById("modalMessage");
      const modalCloseBtn = document.getElementById("modalCloseBtn");

      let currentUserEmail = null;
      let currentUserId = null;

      const messageDomElements = {};

      async function typeMessage(targetElement, textToType, delay = 20) {
        targetElement.innerHTML = "";
        for (let i = 0; i < textToType.length; i++) {
          let char = textToType.charAt(i);
          if (char === "\n") {
            targetElement.innerHTML += "<br>";
          } else {
            targetElement.innerHTML += char;
          }

          targetElement.innerHTML = targetElement.innerHTML.replace(
            /\*\*(.*?)\*\*/g,
            "<strong>$1</strong>"
          );
          targetElement.innerHTML = targetElement.innerHTML.replace(
            /\*(.*?)\*/g,
            "<em>$1</em>"
          );

          await new Promise((resolve) => setTimeout(resolve, delay));
          chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }
      }

      function showModal(title, message) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modal.classList.remove("hidden");
      }

      modalCloseBtn.addEventListener("click", () => {
        modal.classList.add("hidden");
      });

      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUserEmail = user.email;
          currentUserId = user.uid;
          welcomeMessage.textContent = `Halo, ${user.email.split("@")[0]}!`;
          contentDiv.classList.remove("hidden");

          loadChatMessages(currentUserId);
        } else {
          console.log("Pengguna belum login, mengarahkan ke halaman login.");
          window.location.href = "index.html";
        }
      });

      logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          console.log("Pengguna berhasil logout.");
        } catch (error) {
          console.error("Gagal logout:", error.message);
          showModal(
            "Gagal Logout",
            "Terjadi kesalahan saat logout. Silakan coba lagi."
          );
        }
      });

      async function generateAIResponse(userPrompt, history) {
        loadingIndicator.classList.remove("hidden");
        sendMessageBtn.disabled = true;
        chatInput.disabled = true;

        const payload = {
          contents: [
            ...history,
            { role: "user", parts: [{ text: userPrompt }] },
          ],
        };

        // GANTI DENGAN KUNCI API YANG SUDAH KAMU DAPATKAN!
        const apiKey = "AIzaSyASz8fEtWreRNQcD_ucLYfG6ZxQWUjU_uU";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const result = await response.json();

          if (
            result.candidates &&
            result.candidates.length > 0 &&
            result.candidates[0].content &&
            result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0
          ) {
            const aiText = result.candidates[0].content.parts[0].text;
            return aiText;
          } else {
            console.error("Struktur respons AI tidak terduga:", result);
            showModal(
              "Kesalahan AI",
              "AI tidak dapat menghasilkan balasan. Periksa konsol browser."
            );
            return "Maaf, AI tidak dapat menghasilkan balasan saat ini.";
          }
        } catch (error) {
          console.error("Error memanggil Gemini API:", error);
          showModal(
            "Kesalahan Koneksi AI",
            "Ada masalah saat menghubungi AI. Periksa koneksi internet atau API Key Anda."
          );
          return "Maaf, ada masalah saat menghubungi AI. Silakan coba lagi.";
        } finally {
          loadingIndicator.classList.add("hidden");
          sendMessageBtn.disabled = false;
          chatInput.disabled = false;
        }
      }

      sendMessageBtn.addEventListener("click", async () => {
        const messageText = chatInput.value.trim();
        if (messageText && currentUserEmail && currentUserId) {
          if (initialChatMessage) {
            initialChatMessage.style.display = "none";
          }
          chatInput.value = ""; // Hapus input setelah pesan dikirim

          try {
            // Dapatkan riwayat chat sebelum mengirim pesan baru
            const messagesRef = collection(
              db,
              "chats",
              currentUserId,
              "messages"
            );
            const q = query(messagesRef, orderBy("timestamp", "asc"));
            const querySnapshot = await getDocs(q);
            const chatHistory = [];

            // Tambahkan instruksi persona di awal riwayat
            chatHistory.push({
              role: "user",
              parts: [
                {
                  text: "Saya adalah konsultan AI bernama Lius Retang. Saya dikembangkan oleh Yulius Panduakatidahu, seorang mahasiswa dari Universitas STEKOM jurusan Sistem Komputer. Misi Anda adalah menyediakan konsultasi yang ramah, informatif, dan akurat kepada pengguna. Anda harus **selalu menjawab pertanyaan secara langsung, tanpa melenceng dari topik**. Jelaskan konsep dengan **detail yang cukup, terstruktur dengan baik**, menggunakan **paragraf-paragraf terpisah**, dan **poin-poin atau daftar bernomor (jika relevan)**. **Gunakan bahasa Indonesia yang jelas dan mudah dipahami.** Berikan respons dalam format *Markdown sederhana* (misal: **bold**, *italic*, list bullet dengan -, atau numbered list dengan 1. 2.).",
                },
              ],
            });
            chatHistory.push({
              role: "model",
              parts: [
                {
                  text: "Siap, saya mengerti. Saya akan menjawab setiap pertanyaan sesuai instruksi.",
                },
              ],
            });

            querySnapshot.forEach((doc) => {
              const data = doc.data();
              const role = data.sender === "AI Konsultan" ? "model" : "user";
              chatHistory.push({ role, parts: [{ text: data.text }] });
            });

            // Kirim pesan pengguna ke database
            await addDoc(collection(db, "chats", currentUserId, "messages"), {
              text: messageText,
              sender: currentUserEmail,
              timestamp: serverTimestamp(),
            });

            // Panggil AI dengan riwayat lengkap dan pertanyaan terbaru
            const aiResponse = await generateAIResponse(
              messageText,
              chatHistory
            );

            if (
              aiResponse &&
              aiResponse.length > 0 &&
              !aiResponse.includes(
                "Maaf, AI tidak dapat menghasilkan balasan"
              ) &&
              !aiResponse.includes("Maaf, ada masalah saat menghubungi AI")
            ) {
              await addDoc(collection(db, "chats", currentUserId, "messages"), {
                text: aiResponse,
                sender: "AI Konsultan",
                timestamp: serverTimestamp(),
              });
            }
          } catch (e) {
            console.error(
              "Error saat mengirim pesan atau mendapatkan balasan AI: ",
              e
            );
            showModal(
              "Kesalahan",
              "Gagal mengirim pesan atau mendapatkan balasan dari AI."
            );
          }
        } else if (!messageText) {
          showModal("Pesan Kosong", "Pesan tidak boleh kosong!");
        } else if (!currentUserId) {
          showModal(
            "Kesalahan Otentikasi",
            "Sesi pengguna tidak valid. Silakan coba login kembali."
          );
        }
      });

      function loadChatMessages(userId) {
        if (!userId) {
          console.error("UID pengguna tidak tersedia untuk memuat chat.");
          return;
        }

        let isInitialLoad = true;

        const messagesQuery = query(
          collection(db, "chats", userId, "messages"),
          orderBy("timestamp", "asc")
        );

        onSnapshot(
          messagesQuery,
          (snapshot) => {
            if (snapshot.size > 0 && initialChatMessage) {
              initialChatMessage.style.display = "none";
            } else if (snapshot.size === 0 && initialChatMessage) {
              initialChatMessage.style.display = "block";
            }

            const currentDomMessageIds = new Set();
            chatMessagesDiv
              .querySelectorAll(".message-container")
              .forEach((el) => {
                if (el.dataset.docId) {
                  currentDomMessageIds.add(el.dataset.docId);
                }
              });

            const changes = snapshot.docChanges();
            const hasAddedDocsInThisSnapshot = changes.some(
              (change) => change.type === "added"
            );

            changes.forEach((change) => {
              const message = change.doc.data();
              const messageId = change.doc.id;
              const messageTime = message.timestamp
                ? new Date(message.timestamp.toDate()).toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                  })
                : "Sekarang";

              if (change.type === "added") {
                if (!currentDomMessageIds.has(messageId)) {
                  const messageContainer = document.createElement("div");
                  messageContainer.classList.add(
                    "message-container",
                    message.sender === currentUserEmail ? "sent" : "received"
                  );
                  messageContainer.dataset.docId = messageId;

                  const messageBubble = document.createElement("div");
                  // Hapus `align-self` dan `align-items` dari sini dan atur melalui `message-container` atau `message-bubble` global
                  messageBubble.classList.add("message-bubble");
                  messageBubble.classList.add(
                    message.sender === currentUserEmail ? "sent" : "received"
                  );

                  if (message.sender !== currentUserEmail) {
                    const senderName = document.createElement("span");
                    senderName.classList.add("message-sender");
                    senderName.textContent =
                      message.sender === "AI Konsultan"
                        ? "AI Konsultan:"
                        : message.sender.split("@")[0] + ":";
                    messageBubble.appendChild(senderName);
                  }

                  const messageTextElement = document.createElement("div");
                  // Tambahkan class untuk memastikan teks mengisi bubble
                  messageTextElement.classList.add("message-text-content");
                  const timeElement = document.createElement("span");
                  timeElement.classList.add("message-time");
                  timeElement.textContent = messageTime;

                  messageBubble.appendChild(messageTextElement);
                  messageBubble.appendChild(timeElement);
                  messageContainer.appendChild(messageBubble);

                  chatMessagesDiv.appendChild(messageContainer);

                  messageDomElements[messageId] = {
                    container: messageContainer,
                    textElement: messageTextElement,
                  };

                  if (message.sender === "AI Konsultan") {
                    if (isInitialLoad && hasAddedDocsInThisSnapshot) {
                      messageTextElement.innerHTML = message.text.replace(
                        /\n/g,
                        "<br>"
                      );
                      messageTextElement.innerHTML =
                        messageTextElement.innerHTML.replace(
                          /\*\*(.*?)\*\*/g,
                          "<strong>$1</strong>"
                        );
                      messageTextElement.innerHTML =
                        messageTextElement.innerHTML.replace(
                          /\*(.*?)\*/g,
                          "<em>$1</em>"
                        );
                    } else {
                      typeMessage(messageTextElement, message.text);
                    }
                  } else {
                    messageTextElement.innerHTML = message.text.replace(
                      /\n/g,
                      "<br>"
                    );
                    messageTextElement.innerHTML =
                      messageTextElement.innerHTML.replace(
                        /\*\*(.*?)\*\*/g,
                        "<strong>$1</strong>"
                      );
                    messageTextElement.innerHTML =
                      messageTextElement.innerHTML.replace(
                        /\*(.*?)\*/g,
                        "<em>$1</em>"
                      );
                  }
                }
              } else if (change.type === "modified") {
                console.log("Pesan dimodifikasi:", message);
                const existingElement = messageDomElements[messageId];
                if (existingElement) {
                  if (
                    existingElement.textElement.textContent !== message.text &&
                    message.sender !== "AI Konsultan"
                  ) {
                    existingElement.textElement.innerHTML =
                      message.text.replace(/\n/g, "<br>");
                    existingElement.textElement.innerHTML =
                      existingElement.textElement.innerHTML.replace(
                        /\*\*(.*?)\*\*/g,
                        "<strong>$1</strong>"
                      );
                    existingElement.textElement.innerHTML =
                      existingElement.textElement.innerHTML.replace(
                        /\*(.*?)\*/g,
                        "<em>$1</em>"
                      );
                  }
                  existingElement.container.querySelector(
                    ".message-time"
                  ).textContent = messageTime;
                }
              } else if (change.type === "removed") {
                console.log("Pesan dihapus:", message);
                const existingElement = messageDomElements[messageId];
                if (existingElement && existingElement.container.parentNode) {
                  existingElement.container.parentNode.removeChild(
                    existingElement.container
                  );
                  delete messageDomElements[messageId];
                }
              }
            });

            if (isInitialLoad && hasAddedDocsInThisSnapshot) {
              isInitialLoad = false;
            }

            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
          },
          (error) => {
            console.error("Error mendengarkan pesan: ", error);
            showModal("Kesalahan Chat", "Gagal memuat pesan chat.");
          }
        );
      }

      // === Fungsionalitas Tema Warna dan Audio ===
      const currentTheme = localStorage.getItem("theme") || "theme-green";
      document.body.classList.add(currentTheme);

      themeToggleBtn.addEventListener("click", () => {
        if (document.body.classList.contains("theme-green")) {
          document.body.classList.remove("theme-green");
          document.body.classList.add("theme-pink");
          localStorage.setItem("theme", "theme-pink");
        } else {
          document.body.classList.remove("theme-pink");
          document.body.classList.add("theme-green");
          localStorage.setItem("theme", "theme-green");
        }

        if (backgroundMusic.paused) {
          backgroundMusic
            .play()
            .catch((e) => console.error("Error playing music:", e));
        } else {
          backgroundMusic.pause();
        }
      });
    </script>
  </body>
</html>
